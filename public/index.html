<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Visualization - Uttar Pradesh</title>
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üå°Ô∏è</text></svg>">
    <link rel="stylesheet" href="css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
    <!-- Fallback mechanism if the page doesn't load within 30 seconds -->
    <script>
        // Set a timeout to redirect to the fallback page if the app doesn't load
        const loadTimeout = setTimeout(function() {
            window.location.href = '/fallback.html';
        }, 30000);
        
        // Function to cancel the timeout if the app loads successfully
        window.appLoaded = function() {
            clearTimeout(loadTimeout);
            console.log("App loaded successfully, fallback timeout cleared");
        };
    </script>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>Climate Visualization</h1>
            <h2>Uttar Pradesh, India</h2>
            
            <div class="control-panel">
                <div class="time-lapse-controls">
                    <h3>Historical Temperature</h3>
                    
                    <!-- Progress Loading Section -->
                    <div id="bulk-loading-section">
                        <button id="load-all-data-btn">Load All Historical Data (1979-2020)</button>
                        <div id="loading-progress" class="hidden">
                            <div class="progress-bar">
                                <div id="progress-fill" class="progress-fill"></div>
                            </div>
                            <div class="progress-text">
                                <span id="progress-percentage">0%</span>
                                <span id="progress-status">Preparing...</span>
                            </div>
                        </div>
                        
                        <!-- Cache Status Display -->
                        <div id="cache-status" class="cache-status hidden">
                            <h4>üìä Cached Data Status</h4>
                            <div class="cache-grid">
                                <div class="cache-item">
                                    <span class="cache-label">üå°Ô∏è Temperature:</span>
                                    <span id="cache-temp-count">0</span> years
                                </div>
                                <div class="cache-item">
                                    <span class="cache-label">üå¶Ô∏è Weather:</span>
                                    <span id="cache-weather-count">0</span> years
                                </div>
                                <div class="cache-item">
                                    <span class="cache-label">üìà Anomaly:</span>
                                    <span id="cache-anomaly-count">0</span> years
                                </div>
                                <div class="cache-item">
                                    <span class="cache-label">üèîÔ∏è Terrain:</span>
                                    <span id="cache-terrain-count">0</span> years
                                </div>
                            </div>
                            <div class="cache-total">
                                Total: <span id="cache-total-operations">0</span> datasets cached
                            </div>
                        </div>
                    </div>
                    
                    <!-- Year Range Selection -->
                    <div class="year-range-controls">
                        <label for="start-year">Start Year:</label>
                        <input type="number" id="start-year" min="1979" max="2020" value="1979">
                        
                        <label for="end-year">End Year:</label>
                        <input type="number" id="end-year" min="1979" max="2020" value="2020">
                    </div>
                    
                    <div class="quick-range-buttons">
                        <button onclick="setQuickRange(1979, 2020)" class="quick-range-btn">Full Range (42 years)</button>
                        <button onclick="setQuickRange(1990, 2000)" class="quick-range-btn">Test Range (11 years)</button>
                        <button onclick="setQuickRange(2010, 2020)" class="quick-range-btn">Recent Decade</button>
                    </div>
                    
                    <!-- User-Controlled Time-lapse Navigation -->
                    <div id="timelapse-controls" class="hidden">
                        <div class="timelapse-header">
                            <h4>üé¨ Time-lapse Navigator</h4>
                            <div id="timelapse-year-display">Year: <span id="timelapse-current-year">1979</span></div>
                            <div id="timelapse-progress">Year <span id="timelapse-year-index">1</span> of <span id="timelapse-total-years">42</span></div>
                        </div>
                        
                        <div class="timelapse-navigation">
                            <button id="timelapse-start-btn" title="Go to first year">‚èÆÔ∏è First</button>
                            <button id="timelapse-prev-btn" title="Previous year">‚è™ Previous</button>
                            <button id="timelapse-next-btn" title="Next year">‚è© Next</button>
                            <button id="timelapse-end-btn" title="Go to last year">‚è≠Ô∏è Last</button>
                        </div>
                        
                        <div class="timelapse-quick-jump">
                            <label for="timelapse-jump-year">Quick Jump:</label>
                            <select id="timelapse-jump-year">
                                <option value="">Select Year...</option>
                            </select>
                            <button id="timelapse-jump-btn">Go</button>
                        </div>
                        
                        <div class="timelapse-actions">
                            <button id="timelapse-exit-btn">‚ùå Exit Time-lapse</button>
                            <button id="timelapse-auto-play-btn">üé¨ Auto Play</button>
                        </div>
                    </div>
                    
                    <div class="slider-container">
                        <label for="year-slider">Year: <span id="selected-year">2000</span></label>
                        <input type="range" id="year-slider" min="1979" max="2020" value="2000">
                    </div>
                </div>
                
                <div class="prediction-controls">
                    <h3>Future Prediction</h3>
                    <button id="predict-btn">Predict Future Temperatures</button>
                    <div id="prediction-results" class="hidden">
                        <div class="prediction-item">
                            <span class="year">2040:</span>
                            <span id="temp-2040" class="temp"></span>
                        </div>
                        <div class="prediction-item">
                            <span class="year">2050:</span>
                            <span id="temp-2050" class="temp"></span>
                        </div>
                        <div class="prediction-item">
                            <span class="year">2060:</span>
                            <span id="temp-2060" class="temp"></span>
                        </div>
                    </div>
                </div>
                
                <div class="air-quality-panel hidden" id="air-quality-panel">
                    <h3>Current Air Quality</h3>
                    <div class="aqi-display">
                        <div class="aqi-value">
                            <span>AQI: </span>
                            <span id="aqi-value"></span>
                        </div>
                        <div class="aqi-category" id="aqi-category"></div>
                    </div>
                </div>
                
                <div class="solutions-panel">
                    <h3>Solutions</h3>
                    <button id="show-solar-btn">Show Solar Potential</button>
                    <button id="show-cooling-zones-btn">Show Cooling Zones</button>
                </div>
                
                <div class="immersive-panel hidden" id="immersive-panel">
                    <button id="immersive-view-btn">View Immersive Impact</button>
                </div>
                
                <div class="data-info-panel">
                    <h3>Data Information</h3>
                    <div class="info-item">
                        <strong>Dataset:</strong> ERA5 Daily Aggregates
                    </div>
                    <div class="info-item">
                        <strong>Source:</strong> ECMWF via Google Earth Engine
                    </div>
                    <div class="info-item">
                        <strong>Coverage:</strong> 1979-2020 (41 years)
                    </div>
                    <div class="info-item">
                        <strong>Parameter:</strong> Mean 2m Air Temperature
                    </div>
                    <div class="info-item">
                        <strong>Region:</strong> Uttar Pradesh, India
                    </div>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
        
        <div id="immersive-overlay" class="hidden">
            <button id="close-immersive-btn">√ó</button>
            <div id="immersive-content"></div>
        </div>
        
        <div id="loading-spinner">
            <button id="close-loading-btn" onclick="window.hideLoadingSpinner && window.hideLoadingSpinner()" style="position: absolute; top: 20px; right: 20px; background: transparent; border: none; color: #1a73e8; font-size: 24px; cursor: pointer; z-index: 2001;" title="Close loading screen">&times;</button>
            <div class="spinner"></div>
            <div class="loading-text">Loading...</div>
        </div>
        
        <div id="error-message" class="hidden" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #fce8e6; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); max-width: 80%; text-align: center;">
            <h3 style="color: #d93025; margin-top: 0;">Error Loading Map</h3>
            <p id="error-text">There was a problem loading the map. Please try refreshing the page.</p>
            <div>
                <button onclick="location.reload()" style="background-color: #1a73e8; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px;">Refresh Page</button>
                <button onclick="window.location.href='/test'" style="background-color: #5f6368; color: white; border: none; padding: 10px 15px; border-radius: 4px; cursor: pointer;">Go to Test Page</button>
            </div>
        </div>
    </div>
    
    <!-- 
    To get a Google Maps API key:
    1. Go to https://console.cloud.google.com/
    2. Create a project or select your existing project
    3. Enable the following APIs:
       - Maps JavaScript API
       - Places API
       - Distance Matrix API
    4. Create an API key and replace the placeholder below
    -->
    <!-- Load wind-gl library for wind visualization -->
    <script src="https://unpkg.com/mapbox-gl@2.0.0/dist/mapbox-gl.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mapbox/webgl-wind@master/dist/wind-gl.js"></script>
    
    <!-- Load data and app scripts -->
    <script src="js/data.js"></script>
    <script src="js/app.js"></script>
    <!-- Load Google Maps API with proper async loading -->
    <script>
      // Global callback function for Google Maps
      window.initGoogleMaps = function() {
        console.log('Google Maps API loaded via callback');
        if (typeof window.initMap === 'function') {
          window.initMap();
        } else {
          console.error('initMap function not found');
          // Fallback - try calling initMapInternal directly
          if (typeof window.initMapInternal === 'function') {
            window.initMapInternal();
          }
        }
      };
      
      // Load Google Maps API script
      (function() {
        const script = document.createElement('script');
        script.src = 'https://maps.googleapis.com/maps/api/js?key=AIzaSyBR5_tFhPYuUTaaNgvPBbSzy8VnPSZTJNo&libraries=places&loading=async&callback=initGoogleMaps';
        script.async = true;
        script.defer = true;
        script.onerror = function() {
          console.error('Failed to load Google Maps API');
          const errorMessage = document.getElementById('error-message');
          const errorText = document.getElementById('error-text');
          if (errorMessage && errorText) {
            errorText.textContent = 'Failed to load Google Maps API. Please check your internet connection.';
            errorMessage.classList.remove('hidden');
          }
        };
        document.head.appendChild(script);
      })();
    </script>
</body>
</html>
